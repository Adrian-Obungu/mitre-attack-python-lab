
import argparse
import matplotlib.pyplot as plt

def plot_memory_usage(data_file):
    """
    Parses a memory usage data file and generates a plot.
    """
    times = []
    memory = []

    try:
        with open(data_file, 'r') as f:
            for line in f:
                if line.startswith('#') or not line.strip():
                    continue
                try:
                    t, m = line.split(',')
                    times.append(float(t))
                    memory.append(float(m))
                except ValueError:
                    print(f"Warning: Skipping malformed line: {line.strip()}")
                    continue
    except FileNotFoundError:
        print(f"Error: Data file not found at {data_file}")
        return
    except Exception as e:
        print(f"An error occurred while reading the file: {e}")
        return

    if not times or not memory:
        print("No data to plot.")
        return

    output_file = "memory_usage.png"

    plt.figure(figsize=(12, 6))
    plt.plot(times, memory, label="Memory Usage")
    plt.xlabel("Time (seconds)")
    plt.ylabel("Memory (MB)")
    plt.title("Memory Usage Over Time")
    plt.grid(True)
    plt.legend()
    
    try:
        plt.savefig(output_file)
        print(f"Plot saved to {output_file}")
    except Exception as e:
        print(f"Error saving plot: {e}")

def main():
    parser = argparse.ArgumentParser(description="Plot memory usage data from a file.")
    parser.add_argument("data_file", help="The .dat file generated by the memory profiler.")
    args = parser.parse_args()
    
    plot_memory_usage(args.data_file)

if __name__ == "__main__":
    main()
